<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Quartz.net</title>
    <!-- Animate.css -->
    <link rel="stylesheet" href="../css/animate.css">
    <!-- Icomoon Icon Fonts-->
    <link rel="stylesheet" href="../css/icomoon.css">
    <!-- Bootstrap  -->
    <link rel="stylesheet" href="../css/bootstrap.css">

    <!-- Theme style  -->
    <link rel="stylesheet" href="../css/style.css">

    <!-- Modernizr JS -->
    <script src="../js/modernizr-2.6.2.min.js"></script>




</head>
<body class="single">

<div class="fh5co-loader"></div>

<div id="page">
    <div id="fh5co-aside" style="background-image: url(../images/background.jpg)" data-stellar-background-ratio="0.5">
        <div class="overlay"></div>
        <nav role="navigation">
            <ul>
                <li><a href="../"><i class="icon-home"></i></a></li>
            </ul>
        </nav>
        <div class="page-title">
            <img src="../images/project-4.jpg" alt="">
            <span>September 14, 2016</span>
            <h2>Quartz.net 开源job调度框架（一）</h2>
        </div>
    </div>
    <div id="fh5co-main-content">
        <div class="fh5co-post">
            <div class="fh5co-entry padding">
                <div>
                    <p>&emsp;&emsp;Quartz.NET是一个开源的作业调度框架，非常适合在平时的工作中，定时轮询数据库同步，定时邮件通知，定时处理数据等。 </p>
                    <p>&emsp;&emsp;Quartz.NET允许开发人员根据时间间隔（或天）来调度作业。它实现了作业和触发器的多对多关系，还能把多个作业与不同的触发器关联。</p>
                    <p>&emsp;&emsp;整合了 Quartz.NET的应用程序可以重用来自不同事件的作业，还可以为一个事件组合多个作业。</p>
                    <p>官方学习文档：<a href="http://www.quartz-scheduler.net/documentation/index.html">http://www.quartz-scheduler.net/documentation/index.html</a></p>
                    <p>使用实例介绍：<a href="http://www.quartz-scheduler.net/documentation/quartz-2.x/quick-start.html">http://www.quartz-scheduler.net/documentation/quartz-2.x/quick-start.html
                        </a>  
                    </p>
                    <p>官方的源代码下载：<a href="http://sourceforge.net/projects/quartznet/files/quartznet/">http://sourceforge.net/projects/quartznet/files/quartznet/</a>   
                    </p>
                    <p>下面将结合我的项目中的使用给大家分享一下</p>
                    <ul>
                        <li>为什么要使用Quartz？  
                        </li>
                    </ul>
                    <p>我们经常会有这样的应用场景：需要定时轮询某些符合条件的数据，在达到一定条件的时候，对数据做出一定的处理，比如：电商平台要搞促销活动，设定好活动开始时间，在到达开始时间的时候定时推一些促销信息到网站前台。这时我们常用的方法有：windows service，console job等等方式来处理，本文以Quartz调度console job来实现。</p>
                    <pre><code>项目的总体思路是：用Windows Service把主程序Host起来，然后通过Quartz.net的可视化界面控制Job的执行和调度
</code></pre>

                    <p>首先创建Console Job程序，下载Quartz相关的包（Quartz.NET，CrystalQuartz.Remote），通过Nuget安装的话，相关依赖包会自动下载。  
                    </p>
                    <p><img src="http://images2015.cnblogs.com/blog/423536/201609/423536-20160914180738305-185856043.png" />  
                    </p>
                    <p>&emsp;&emsp;使用这个框架的最大的好处就是业务便于横向扩展，比如目前根据业务来说我有两个实现的功能，一个是抢购的商品到时间之后定时上下架，还有一个是超时订单15分钟未支付自动作废，我在项目中新建两个文件夹，放各自的业务处理类，其他的都是公用的。</p>
                    <p>接下来看具体的实现： </p>
                    <p><img src="http://images2015.cnblogs.com/blog/423536/201609/423536-20160914181003305-2011083084.png" />  
                    </p>
                    <p>程序主入口用Service Run起来。</p>
                    <p>JobManager是添加的系统组建，里面的实现如下：</p>
                    <p><img src="http://images2015.cnblogs.com/blog/423536/201609/423536-20160914181227742-1525816361.png" />  
                    </p>
                    <p>ServiceBase中的代码很关键，起到配置线程池的作用，这个地方设置线程池信息是整个框架在调度的时候通用的配置  
                    </p>
                    <p><img src="http://images2015.cnblogs.com/blog/423536/201609/423536-20160914181432898-1813366046.png" />  
                    </p>
                    <p>新建一个作业调度的基类：JobService，实现如下：  
                    </p>
                    <p><img src="http://images2015.cnblogs.com/blog/423536/201609/423536-20160914181650445-962024919.png" />  
                    </p>
                    <p>主要用于设置Job的名称，作业组的名称，还有给调度器中添加每一个作业信息和各自的触发器信息</p>
                    <p>接下来基本的配置实现已经完成了，我们来看看具体的作业是怎么实现的？  
                    </p>
                    <p><img src="http://images2015.cnblogs.com/blog/423536/201609/423536-20160914182208148-2049628077.png" />  
                    </p>
                    <p>各自的业务处理模块的模板都和这个类似，具体可根据自己的习惯来实现。关于触发器的配置还有另外一种做法，就是通过配置文件来实现，大家可以百度一下。</p>
                    <p>业务处理类中就根据各自不同的业务做具体的实现了，代码如下：  
                    </p>
                    <p><img src="http://images2015.cnblogs.com/blog/423536/201609/423536-20160914182350586-1624757390.png" />  
                    </p>
                    <p>项目中纪录Log（这个很重要，非常重要）使用Nlog，数据库访问使用Dapper（轻量级的ORM，特别好用，性能也很好）</p>
                    <p>Job的工作已经基本完成了，接下来要做就是把添加安装文件，将Job做成Windows Service安装到服务器了，这个步骤就不再啰嗦了（如果不知道的童鞋可以百度，或者联系我要源码）</p>
                    <p>下面我们还剩最后一步，就是开始我们说的可视化控制，截至到目前我们做的都是不可见的服务，怎么用可视化的界面呈现给用户呢？继续往下</p>
                    <p>新建一个空的ASP.NET WebSite，安装CrystalQuartz.Remote 包，这个可以使得你在Web站点里面访问到框架生成的可视化界面。  
                    </p>
                    <p><img src="http://images2015.cnblogs.com/blog/423536/201609/423536-20160914183329523-1592964765.png" />  
                    </p>
                    <p><img src="http://images2015.cnblogs.com/blog/423536/201609/423536-20160914183339398-806099969.png" />  
                    </p>
                    <p>&emsp;&emsp;安装完包之后我们可以看到在WebConfig中添加了相关的配置，最重要的就是SchedulerHost这个配置，这个地方指定的端口号就是我们在最开始创建线程池的时候制定的Port，儿地址就是我们当前服务器部署的地址了，需要说明的一点就是我们的Windows Service部署的服务器和WebSite部署的站点是要在同一个服务器上的。</p>
                    <p>&emsp;&emsp;接下来就是启动将新建的网站部署到IIS，开启WindowsService，然后在浏览器里面浏览新的站点，在默认的端口后面直接输入：/CrystalQuartzPanel.axd 就看访问了  
                    </p>
                    <p><img src="http://images2015.cnblogs.com/blog/423536/201609/423536-20160914183953367-336926027.png" /></p>
                    <p>&emsp;&emsp;看到这么清爽的界面，很是激动人心啊，我们不用自己开发可视化的Job调度框架就可以通过界面来控制我们的服务了，是不是很心动呢？</p>
                    <p>&emsp;&emsp;心动不如行动啊，筒子们如果有想法就动手实践一下，我差不多用了3个小时左右的时间来实践了一下。Quartz框架中的其他功能暂时还没研究。</p>
                    <p>&emsp;&emsp;如果在实现过程中有什么问题可以给我留言，我把源码共享出来，大家一起研究，学习~~</p>
                    <p>示例代码：<a href="https://github.com/KenWang007/JobScheduleDemoCode.git">https://github.com/KenWang007/JobScheduleDemoCode.git</a></p>

                </div>
            </div>



        </div>
    </div>
</div>

<div class="fh5co-navigation">
        
</div>

<footer></footer>

<div class="gototop js-top">
    <a href="#" class="js-gotop"><i class="icon-arrow-up"></i></a>
</div>

<!-- jQuery -->
<script src="../js/jquery.min.js"></script>
<!-- jQuery Easing -->
<script src="../js/jquery.easing.1.3.js"></script>
<!-- Bootstrap -->
<script src="../js/bootstrap.min.js"></script>
<!-- Waypoints -->
<script src="../js/jquery.waypoints.min.js"></script>
<!-- Stellar Parallax -->
<script src="../js/jquery.stellar.min.js"></script>
<!-- Main -->
<script src="../js/main.js"></script>
</body>
</html>

